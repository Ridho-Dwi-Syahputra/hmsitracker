<% var old = typeof old !== 'undefined' ? old : {}; %>
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title><%= title %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://kit.fontawesome.com/your-fa-kit.js" crossorigin="anonymous"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <!-- Navbar -->
  <%- include('../partials/navbarHMSI', { user: user, unreadCount: unreadCount }) %>

  <!-- Sidebar -->
  <%- include('../partials/sidebarHMSI', { activeNav: 'Program Kerja', user: user }) %>

  <!-- Success Modal -->
  <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="successModalContent">
      <div class="text-center">
        <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">Berhasil Disimpan!</h3>
        <p class="text-gray-600 mb-6">Program kerja berhasil diperbarui.</p>
        <button id="closeSuccessModal" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-6 rounded-xl transition-colors duration-200">
          Kembali ke Kelola Proker
        </button>
      </div>
    </div>
  </div>

  <!-- Error Modal -->
  <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="errorModalContent">
      <div class="text-center">
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">Terjadi Kesalahan!</h3>
        <p id="errorMessage" class="text-gray-600 mb-6">Mohon periksa kembali data yang Anda masukkan.</p>
        <button id="closeErrorModal" class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-6 rounded-xl transition-colors duration-200">
          Tutup
        </button>
      </div>
    </div>
  </div>

  <!-- Validation Modal -->
  <div id="validationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="validationModalContent">
      <div class="text-center">
        <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">Data Tidak Lengkap!</h3>
        <p id="validationMessage" class="text-gray-600 mb-6">Mohon lengkapi semua field yang wajib diisi sebelum memperbarui.</p>
        <button id="closeValidationModal" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-3 px-6 rounded-xl transition-colors duration-200">
          Mengerti
        </button>
      </div>
    </div>
  </div>

  <!-- File Size Error Modal -->
  <div id="fileSizeModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="fileSizeModalContent">
      <div class="text-center">
        <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">File Terlalu Besar!</h3>
        <p class="text-gray-600 mb-6">Ukuran file maksimal adalah 5MB. Pilih file lain yang lebih kecil.</p>
        <button id="closeFileSizeModal" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-6 rounded-xl transition-colors duration-200">
          Mengerti
        </button>
      </div>
    </div>
  </div>

  <!-- Wrapper -->
  <main class="lg:ml-80 px-6 pt-20 pb-8 flex-grow">
    <div class="max-w-5xl mx-auto bg-white shadow-xl rounded-2xl overflow-hidden border border-gray-200">

      <!-- Header -->
      <div class="bg-gradient-to-r from-orange-500 to-orange-600 text-white px-6 py-6">
        <h1 class="text-2xl font-bold">Edit Program Kerja</h1>
        <p class="text-sm text-orange-100">Perbarui detail program kerja di bawah</p>
      </div>

      <!-- Body -->
      <div class="p-6 sm:p-8">
        <%- include('../partials/alert', { errorMsg: errorMsg, successMsg: successMsg }) %>

        <form id="editProkerForm" action="/hmsi/proker/<%= proker.id_ProgramKerja %>/edit" method="POST" enctype="multipart/form-data" class="space-y-10">

          <!-- Informasi Dasar -->
          <div>
            <h4 class="text-lg font-semibold text-gray-700 mb-4">Informasi Dasar</h4>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

              <div class="md:col-span-2 bg-gray-50 border p-4 rounded-xl">
                <label class="block text-sm font-medium mb-2">Nama Program Kerja <span class="text-red-500">*</span></label>
                <input type="text" id="namaProker" name="namaProker" value="<%= old.namaProker || proker.Nama_ProgramKerja %>" required
                       class="w-full px-4 py-3 border rounded-lg text-sm focus:border-orange-500 focus:ring-2 focus:ring-orange-100">
                <div class="error-message text-red-500 text-xs mt-1 hidden"></div>
              </div>

              <div class="bg-gray-50 border p-4 rounded-xl">
                <label class="block text-sm font-medium mb-2">Tanggal Mulai <span class="text-red-500">*</span></label>
                <input type="date" id="tanggal_mulai" name="tanggal_mulai" value="<%= old.tanggal_mulai || proker.tanggal_mulaiFormatted %>" required
                       class="w-full px-4 py-3 border rounded-lg text-sm focus:border-orange-500 focus:ring-2 focus:ring-orange-100">
                <div class="error-message text-red-500 text-xs mt-1 hidden"></div>
              </div>

              <div class="bg-gray-50 border p-4 rounded-xl">
                <label class="block text-sm font-medium mb-2">Tanggal Selesai <span class="text-red-500">*</span></label>
                <input type="date" id="tanggal_selesai" name="tanggal_selesai" value="<%= old.tanggal_selesai || proker.tanggal_selesaiFormatted %>" required
                       class="w-full px-4 py-3 border rounded-lg text-sm focus:border-orange-500 focus:ring-2 focus:ring-orange-100">
                <div class="error-message text-red-500 text-xs mt-1 hidden"></div>
              </div>

              <div class="md:col-span-2 bg-gray-50 border p-4 rounded-xl">
                <label class="block text-sm font-medium mb-2">Penanggung Jawab <span class="text-red-500">*</span></label>
                <input type="text" id="penanggungJawab" name="penanggungJawab" value="<%= old.penanggungJawab || proker.Penanggung_jawab %>" required
                       class="w-full px-4 py-3 border rounded-lg text-sm focus:border-orange-500 focus:ring-2 focus:ring-orange-100">
                <div class="error-message text-red-500 text-xs mt-1 hidden"></div>
              </div>

              <div class="md:col-span-2 bg-gray-50 border p-4 rounded-xl">
                <label class="block text-sm font-medium mb-2">Deskripsi Program <span class="text-red-500">*</span></label>
                <textarea id="deskripsi" name="deskripsi" rows="4" required
                          class="w-full px-4 py-3 border rounded-lg text-sm resize-none focus:border-orange-500 focus:ring-2 focus:ring-orange-100"><%= old.deskripsi || proker.Deskripsi %></textarea>
                <div class="error-message text-red-500 text-xs mt-1 hidden"></div>
              </div>
            </div>
          </div>

          <!-- File Dokumen Pendukung -->
<div>
  <h4 class="text-lg font-semibold text-gray-700 mb-1">File Dokumen Pendukung</h4>
  <p class="text-sm text-gray-500 mb-4">Kosongkan jika tidak ingin mengganti file</p>
  <div id="dropzone"
    class="border-2 border-dashed border-gray-300 rounded-xl p-10 bg-gray-50/50 text-center cursor-pointer 
           transition duration-200 hover:border-orange-400 hover:bg-orange-50/30 flex flex-col items-center gap-4">
    <input type="file" name="dokumen_pendukung" id="fileUpload" class="hidden"
      accept=".pdf,.jpg,.jpeg,.png" />
    <div class="text-4xl text-gray-400">ðŸ“„</div>
    <label for="fileUpload" class="cursor-pointer">
      <span class="px-6 py-3 bg-orange-500 text-white rounded-lg text-sm font-medium 
                   transition duration-200 hover:bg-orange-600 hover:shadow-md active:scale-95">
        Pilih File atau Drag & Drop
      </span>
    </label>
    <p class="text-sm text-gray-600">
      Format yang didukung: <span class="font-medium">PDF, JPG, JPEG, PNG</span><br>
      Maksimal ukuran file: <span class="font-medium">5MB</span>
    </p>
  </div>
  <p id="fileName" class="text-sm text-gray-600 mt-3"></p>
  <div class="error-message text-red-500 text-xs mt-1 hidden"></div>

  <% if (proker.Dokumen_pendukung) { %>
    <div class="mt-4 p-4 bg-blue-50 border rounded-lg">
      <h5 class="text-sm font-semibold mb-2 text-blue-800">File Saat Ini:</h5>
      <div class="flex justify-between items-center">
        <span class="text-sm text-blue-700"><%= proker.Dokumen_pendukung %></span>
        <% if (/\.(jpg|jpeg|png)$/i.test(proker.Dokumen_pendukung)) { %>
          <button type="button" onclick="togglePreview()" 
                  class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
            Lihat Preview
          </button>
        <% } else if (/\.pdf$/i.test(proker.Dokumen_pendukung)) { %>
          <a href="/uploads/<%= proker.Dokumen_pendukung %>" target="_blank" 
             class="text-xs bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">
            Buka File
          </a>
        <% } %>
      </div>
      <% if (/\.(jpg|jpeg|png)$/i.test(proker.Dokumen_pendukung)) { %>
        <div id="imagePreview" class="mt-3 hidden">
          <img src="/uploads/<%= proker.Dokumen_pendukung %>" class="max-h-48 rounded-lg border shadow-md">
        </div>
      <% } %>
    </div>
  <% } %>
</div>

          <!-- Tombol -->
          <div class="pt-6 border-t flex gap-4 justify-end">
            <a href="/hmsi/kelola-proker" class="px-8 py-3 border rounded-xl text-sm font-medium bg-white text-gray-700 hover:shadow-md">Batal</a>
            <button type="submit" id="submitBtn" class="flex items-center gap-2 px-8 py-3 text-white bg-orange-500 rounded-xl text-sm font-semibold hover:bg-orange-600">
              <span id="btnText">Simpan</span>
              <div id="btnSpinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <%- include('../partials/footer') %>

  <script>
    // ===== MODAL =====
    function showModal(id){const m=document.getElementById(id);const c=document.getElementById(id+"Content");if(!m||!c)return;m.classList.remove("hidden");setTimeout(()=>{c.classList.remove("scale-95","opacity-0");c.classList.add("scale-100","opacity-100")},10)}
    function hideModal(id){const m=document.getElementById(id);const c=document.getElementById(id+"Content");if(!m||!c)return;c.classList.remove("scale-100","opacity-100");c.classList.add("scale-95","opacity-0");setTimeout(()=>{m.classList.add("hidden")},300)}
    document.getElementById("closeSuccessModal")?.addEventListener("click",()=>{hideModal("successModal");setTimeout(()=>{window.location.href="/hmsi/kelola-proker"},300)});
    document.getElementById("closeErrorModal")?.addEventListener("click",()=>hideModal("errorModal"));
    document.getElementById("closeValidationModal")?.addEventListener("click",()=>hideModal("validationModal"));
    document.getElementById("closeFileSizeModal")?.addEventListener("click",()=>hideModal("fileSizeModal"));
    ["successModal","errorModal","validationModal","fileSizeModal"].forEach(id=>{document.getElementById(id)?.addEventListener("click",e=>{if(e.target.id===id)hideModal(id)})});

    // ===== FILE UPLOAD =====
    const drop=document.getElementById("dropzone"),fi=document.getElementById("fileUpload"),fn=document.getElementById("fileName"),MAX=5*1024*1024;
    drop?.addEventListener("dragover",e=>{e.preventDefault();drop.classList.add("border-orange-400","bg-orange-50")});
    drop?.addEventListener("dragleave",()=>drop.classList.remove("border-orange-400","bg-orange-50"));
    drop?.addEventListener("drop",e=>{e.preventDefault();drop.classList.remove("border-orange-400","bg-orange-50");const f=e.dataTransfer.files;if(f.length>0){if(f[0].size>MAX){showModal("fileSizeModal");fi.value="";fn.textContent="";return}fi.files=f;fn.textContent=`File dipilih: ${f[0].name}`;validateField(fi)}});
    fi?.addEventListener("change",e=>{if(e.target.files.length>0){const f=e.target.files[0];if(f.size>MAX){showModal("fileSizeModal");fi.value="";fn.textContent="";return}fn.textContent=`File dipilih: ${f.name}`;validateField(fi)}else fn.textContent=""});

    // ===== DATE VALIDATION =====
    const mulai=document.getElementById("tanggal_mulai"),selesai=document.getElementById("tanggal_selesai");
    function sync(){if(mulai&&selesai&&mulai.value){selesai.min=mulai.value;if(selesai.value&&selesai.value<mulai.value)selesai.value=mulai.value}}
    mulai?.addEventListener("change",sync);sync();

    function togglePreview(){document.getElementById("imagePreview")?.classList.toggle("hidden")}

    // ===== VALIDATION =====
    function validateField(f){if(!f)return true;const err=f.closest(".bg-gray-50")?.querySelector(".error-message")||f.closest("div")?.querySelector(".error-message");if(!err)return true;let ok=true,msg="";if(f.hasAttribute("required")){if(f.type==="file"){ok=true}else if(f.type==="date"){ok=f.value!=="";msg="Tanggal wajib diisi"}else if(f.value.trim()===""){ok=false;msg="Field ini wajib diisi"}}if(f.type==="date"&&f.value!==""&&f.id==="tanggal_selesai"&&mulai&&mulai.value&&f.value<mulai.value){ok=false;msg="Tanggal selesai tidak boleh sebelum mulai"}if(!ok){err.textContent=msg;err.classList.remove("hidden");f.classList.add("border-red-500");f.classList.remove("border-gray-300")}else{err.classList.add("hidden");f.classList.remove("border-red-500");f.classList.add("border-gray-300")}return ok}
    function validateAll(){let ok=true,emp=[];["namaProker","tanggal_mulai","tanggal_selesai","penanggungJawab","deskripsi"].forEach(id=>{const f=document.getElementById(id);if(f&&(f.value||"").trim()===""){ok=false;emp.push(f.name);validateField(f)}});if(!ok){let msg="";if(emp.length===1)msg=`Field "${emp[0]}" wajib diisi.`;else if(emp.length===2)msg=`Field "${emp[0]}" dan "${emp[1]}" wajib diisi.`;else if(emp.length>2){const last=emp.pop();msg=`Field ${emp.join(", ")} dan ${last} wajib diisi.`}document.getElementById("validationMessage").textContent=msg}return ok}
    document.querySelectorAll("input[required],textarea[required]").forEach(f=>{f.addEventListener("blur",()=>validateField(f));f.addEventListener("input",()=>{if(f.classList.contains("border-red-500"))validateField(f)})});

    // ===== SUBMIT =====
    const form=document.getElementById("editProkerForm"),btn=document.getElementById("submitBtn"),txt=document.getElementById("btnText"),sp=document.getElementById("btnSpinner");
    form?.addEventListener("submit",e=>{e.preventDefault();if(!validateAll()){showModal("validationModal");return}if(fi&&fi.files&&fi.files[0]&&fi.files[0].size>MAX){showModal("fileSizeModal");return}btn.disabled=true;txt.textContent="Menyimpan...";sp.classList.remove("hidden");fetch(form.action,{method:"POST",body:new FormData(form)}).then(r=>{if(r.ok)showModal("successModal");else return r.text().then(t=>{throw new Error(t||"Server error")})}).catch(er=>{document.getElementById("errorMessage").textContent="Terjadi kesalahan: "+er.message;showModal("errorModal")}).finally(()=>{btn.disabled=false;txt.textContent="Simpan";sp.classList.add("hidden")})});
  </script>
</body>
</html>
