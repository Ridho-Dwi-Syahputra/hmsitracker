<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title><%= title %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Sidebar DPA -->
  <%- include('../partials/sidebarDPA', { activeNav: 'Laporan', user: user }) %>

  <!-- Wrapper -->
  <div class="lg:ml-80 opacity-0 animate-fade-in" style="animation-delay:150ms;">

    <!-- Header -->
    <div class="bg-white border-b border-gray-200">
      <div class="max-w-4xl mx-auto px-6 py-6 flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-800 opacity-0 animate-slide-down" style="animation-delay:350ms;">
          Evaluasi Laporan
        </h1>
        <a href="/dpa/laporan/<%= laporan.id_laporan %>"
          class="flex items-center gap-2 px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all duration-200 transform hover:scale-105 active:scale-95 hover:shadow-md opacity-0 animate-slide-in-right"
          style="animation-delay:600ms;">
          <i class="fa-solid fa-arrow-left"></i>
          <span class="font-medium">Kembali</span>
        </a>
      </div>
    </div>

    <!-- Main -->
    <div class="px-6 py-10 opacity-0 animate-slide-up" style="animation-delay:650ms;">
      <div class="max-w-4xl mx-auto bg-white rounded-2xl border border-gray-200 shadow-sm p-8">

        <!-- Card Header -->
        <div class="mb-8 border-b border-gray-100 pb-6">
          <h3 class="text-xl font-bold text-gray-800 mb-2">Form Evaluasi</h3>
          <p class="text-gray-600 text-sm">Silakan isi komentar dan status evaluasi untuk laporan berikut.</p>
        </div>

        <!-- ALERT -->
        <%- include('../partials/alert', { errorMsg: errorMsg, successMsg: successMsg }) %>

        <!-- Info laporan singkat -->
        <div class="mb-6 bg-orange-50 border border-orange-200 rounded-lg p-4 space-y-1">
          <p class="text-sm text-gray-700">
            <span class="font-medium">Judul Laporan   :</span> <%= laporan.judul_laporan || '-' %>
          </p>
          <p class="text-sm text-gray-700">
            <span class="font-medium">Program Kerja   :</span> <%= laporan.namaProker || '-' %>
          </p>
          <p class="text-sm text-gray-700">
            <span class="font-medium">Divisi HMSI     :</span> <%= laporan.divisi || '-' %>
          </p>
          <p class="text-sm text-gray-700">
            <span class="font-medium">Tanggal Upload  :</span> <%= laporan.tanggalFormatted || '-' %>
          </p>
        </div>

        <!-- Preview Dokumentasi -->
        <div class="mb-8">
          <h4 class="text-lg font-semibold text-orange-600 mb-4">Preview Dokumentasi</h4>
          <% if (laporan.dokumentasi) { %>
            <% if (laporan.dokumentasi_mime === 'application/pdf') { %>
              <embed src="/uploads/<%= laporan.dokumentasi %>" 
                     type="application/pdf" 
                     width="100%" 
                     height="420px"
                     class="rounded-lg border-2 border-orange-500"/>   
            <% } else if (laporan.dokumentasi_mime === 'image/jpeg' || laporan.dokumentasi_mime === 'image/png') { %>
              <img src="/uploads/<%= laporan.dokumentasi %>" alt="Dokumentasi" class="w-full max-h-96 object-contain rounded-lg border shadow"/>
              <a href="/uploads/<%= laporan.dokumentasi %>" class="mt-3 inline-block px-4 py-2 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium hover:bg-orange-200 transition">Download Gambar</a>
            <% } else { %>
              <div class="p-4 bg-gray-50 border rounded-lg flex items-center justify-between">
                <div>
                  <p class="font-medium"><%= laporan.dokumentasi %></p>
                  <p class="text-xs text-gray-500">Tipe file tidak dapat dipreview â€” silakan unduh.</p>
                </div>
                <a href="/uploads/<%= laporan.dokumentasi %>" class="px-3 py-2 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium">Download</a>
              </div>
            <% } %>
          <% } else { %>
            <p class="text-gray-600 text-sm">Tidak ada dokumentasi diunggah.</p>
          <% } %>
        </div>

        <!-- Komentar HMSI -->
        <% if (laporan.komentar_hmsi) { %>
        <div class="mb-8">
          <h4 class="text-lg font-semibold text-teal-600 mb-4">Komentar HMSI</h4>
          <div class="p-4 bg-teal-50 border border-teal-200 rounded-lg space-y-2">
            <p class="text-gray-800 whitespace-pre-line"><%= laporan.komentar_hmsi %></p>
          </div>
        </div>
        <% } %>

        <!-- Form Evaluasi -->
        <form action="/dpa/laporan/<%= laporan.id_laporan %>/evaluasi" method="POST" class="space-y-6">

          <!-- Komentar Evaluasi -->
          <div>
            <label for="komentar" class="block text-sm font-medium text-gray-700">Komentar Evaluasi</label>
            <textarea id="komentar" name="komentar" rows="5" required
                class="mt-2 block w-full rounded-xl border border-gray-300 shadow-sm 
                    focus:border-orange-500 focus:ring-2 focus:ring-orange-500 
                    focus:bg-orange-50 text-gray-900 placeholder-gray-400 focus:placeholder-orange-400
                    transition-all duration-300 ease-in-out p-3 outline-none"
                placeholder="Tulis komentar evaluasi di sini..."></textarea>
          </div>

          <!-- Status Evaluasi (Custom Dropdown) -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Status Evaluasi</label>
            <div class="relative w-60">
              <button id="dropdownButton" type="button"
                class="flex items-center justify-between w-full px-4 py-3 border border-gray-300 rounded-xl text-sm bg-white
                       hover:border-orange-500 hover:shadow-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-200">
                <span id="dropdownLabel">Pilih Status</span>
                <i class="fa-solid fa-chevron-down text-orange-500"></i>
              </button>
              <div id="dropdownMenu"
                class="hidden absolute left-0 mt-2 w-full bg-white border border-orange-200 rounded-lg shadow-lg z-10">
                <ul class="text-sm text-gray-700">
                  <li><button type="button" class="w-full text-left px-4 py-2 hover:bg-orange-100" data-value="Revisi">Revisi</button></li>
                  <li><button type="button" class="w-full text-left px-4 py-2 hover:bg-orange-100" data-value="Selesai">Selesai</button></li>
                </ul>
              </div>
            </div>
            <input type="hidden" name="status_konfirmasi" id="statusInput" required>
          </div>

          <!-- Hidden Pemberi Evaluasi (auto dari req.session) -->
          <input type="hidden" name="id_anggota" value="<%= user.id_anggota %>">

          <!-- Tombol -->
          <div class="flex justify-end gap-3">
            <a href="/dpa/laporan/<%= laporan.id_laporan %>"
              class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl text-sm font-medium hover:bg-gray-300 transition">
              Batal
            </a>
            <button type="submit"
              class="px-6 py-3 bg-orange-500 text-white rounded-xl text-sm font-semibold hover:bg-orange-600 transition transform hover:scale-105 active:scale-95">
              Simpan Evaluasi
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Animasi -->
  <style>
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    @keyframes slideDown { from {opacity:0; transform:translateY(-20px);} to {opacity:1; transform:translateY(0);} }
    @keyframes slideUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
    @keyframes slideInRight { from {opacity:0; transform:translateX(30px);} to {opacity:1; transform:translateX(0);} }

    .animate-fade-in { animation: fadeIn 0.7s ease-out forwards; }
    .animate-slide-down { animation: slideDown 0.8s ease-out forwards; }
    .animate-slide-up { animation: slideUp 0.6s ease-out forwards; }
    .animate-slide-in-right { animation: slideInRight 0.8s ease-out forwards; }

    /* Animasi pulse oren */
    @keyframes pulseOrange {
      0% { box-shadow: 0 0 0 0 rgba(249,115,22, 0.4); }
      70% { box-shadow: 0 0 0 6px rgba(249,115,22, 0); }
      100% { box-shadow: 0 0 0 0 rgba(249,115,22, 0); }
    }

    textarea:focus {
      animation: pulseOrange 1s infinite;
    }
  </style>

  <!-- Script Dropdown -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const dropdownButton = document.getElementById("dropdownButton");
      const dropdownMenu = document.getElementById("dropdownMenu");
      const dropdownLabel = document.getElementById("dropdownLabel");
      const statusInput = document.getElementById("statusInput");

      dropdownButton.addEventListener("click", () => {
        dropdownMenu.classList.toggle("hidden");
      });

      dropdownMenu.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          statusInput.value = btn.dataset.value;
          dropdownLabel.textContent = btn.dataset.value;
          dropdownMenu.classList.add("hidden");
        });
      });
    });
  </script>

</body>
</html>
