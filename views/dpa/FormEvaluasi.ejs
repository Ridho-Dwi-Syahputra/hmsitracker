<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title><%= title %></title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Navbar -->
  <%- include('../partials/navbarDPA', { user: user, unreadCount: unreadCount }) %>

  <!-- Sidebar DPA -->
  <%- include('../partials/sidebarDPA', { activeNav: 'Laporan', user: user }) %>

  <!-- Success Modal -->
  <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="successModalContent">
      <div class="text-center">
        <!-- Success Icon -->
        <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
        </div>
        
        <!-- Title -->
        <h3 id="successModalTitle" class="text-xl font-bold text-gray-900 mb-2">Evaluasi Berhasil Disimpan!</h3>
        
        <!-- Message -->
        <p id="successModalMessage" class="text-gray-600 mb-6">Komentar evaluasi telah berhasil disimpan dan status laporan telah diperbarui.</p>
        
        <!-- Button -->
        <button id="closeSuccessModal" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-6 rounded-xl transition-colors duration-200">
          Kembali ke Daftar Laporan
        </button>
      </div>
    </div>
  </div>

  <!-- Error Modal -->
  <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="errorModalContent">
      <div class="text-center">
        <!-- Error Icon -->
        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </div>
        
        <!-- Title -->
        <h3 id="errorModalTitle" class="text-xl font-bold text-gray-900 mb-2">Gagal Menyimpan Evaluasi!</h3>
        
        <!-- Message -->
        <p id="errorMessage" class="text-gray-600 mb-6">Terjadi kesalahan saat menyimpan evaluasi. Mohon coba lagi.</p>
        
        <!-- Button -->
        <button id="closeErrorModal" class="w-full bg-red-500 hover:bg-red-600 text-white font-medium py-3 px-6 rounded-xl transition-colors duration-200">
          Tutup
        </button>
      </div>
    </div>
  </div>

  <!-- Validation Modal -->
  <div id="validationModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="validationModalContent">
      <div class="text-center">
        <!-- Warning Icon -->
        <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        
        <!-- Title -->
        <h3 id="validationModalTitle" class="text-xl font-bold text-gray-900 mb-2">Data Tidak Lengkap!</h3>
        
        <!-- Message -->
        <p id="validationMessage" class="text-gray-600 mb-6">Mohon lengkapi komentar evaluasi dan pilih status sebelum menyimpan.</p>
        
        <!-- Button -->
        <button id="closeValidationModal" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-3 px-6 rounded-xl transition-colors duration-200">
          Mengerti
        </button>
      </div>
    </div>
  </div>

  <!-- Info Modal -->
  <div id="infoModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="infoModalContent">
      <div class="text-center">
        <!-- Info Icon -->
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        
        <!-- Title -->
        <h3 id="infoModalTitle" class="text-xl font-bold text-gray-900 mb-2">Informasi</h3>
        
        <!-- Message -->
        <p id="infoModalMessage" class="text-gray-600 mb-6">Informasi penting untuk Anda.</p>
        
        <!-- Button -->
        <button id="closeInfoModal" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-6 rounded-xl transition-colors duration-200">
          Mengerti
        </button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="confirmModalContent">
      <div class="text-center">
        <!-- Confirm Icon -->
        <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
        </div>
        
        <!-- Title -->
        <h3 id="confirmModalTitle" class="text-xl font-bold text-gray-900 mb-2">Konfirmasi</h3>
        
        <!-- Message -->
        <p id="confirmModalMessage" class="text-gray-600 mb-6">Apakah Anda yakin ingin melanjutkan?</p>
        
        <!-- Buttons -->
        <div class="flex gap-3">
          <button id="cancelConfirmModal" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-3 px-6 rounded-xl transition-colors duration-200">
            Batal
          </button>
          <button id="proceedConfirmModal" class="flex-1 bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-6 rounded-xl transition-colors duration-200">
            Ya
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Modal -->
  <div id="loadingModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="loadingModalContent">
      <div class="text-center">
        <!-- Loading Spinner -->
        <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <div class="w-8 h-8 border-4 border-blue-200 border-t-blue-500 rounded-full animate-spin"></div>
        </div>
        
        <!-- Title -->
        <h3 id="loadingModalTitle" class="text-xl font-bold text-gray-900 mb-2">Memproses...</h3>
        
        <!-- Message -->
        <p id="loadingModalMessage" class="text-gray-600 mb-6">Mohon tunggu sebentar.</p>
      </div>
    </div>
  </div>

  <!-- Wrapper -->
  <div class="lg:ml-80 opacity-0 animate-fade-in" style="animation-delay:150ms;">

    <!-- Header -->
    <div class="bg-white border-b border-gray-200">
      <div class="max-w-4xl mx-auto px-6 py-6 flex items-center justify-between">
        <h1 class="text-2xl font-bold text-gray-800 opacity-0 animate-slide-down" style="animation-delay:350ms;">
          Evaluasi Laporan
        </h1>
        <a href="/dpa/laporan/<%= laporan.id_laporan %>"
          class="flex items-center gap-2 px-4 py-2 text-gray-600 hover:text-gray-800 hover:bg-gray-100 rounded-lg transition-all duration-200 transform hover:scale-105 active:scale-95 hover:shadow-md opacity-0 animate-slide-in-right"
          style="animation-delay:600ms;">
          <i class="fa-solid fa-arrow-left"></i>
          <span class="font-medium">Kembali</span>
        </a>
      </div>
    </div>

    <!-- Main -->
    <div class="px-6 py-10 opacity-0 animate-slide-up" style="animation-delay:650ms;">
      <div class="max-w-4xl mx-auto bg-white rounded-2xl border border-gray-200 shadow-sm p-8">

        <!-- Card Header -->
        <div class="mb-8 border-b border-gray-100 pb-6">
          <h3 class="text-xl font-bold text-gray-800 mb-2">Form Evaluasi</h3>
          <p class="text-gray-600 text-sm">Silakan isi komentar dan status evaluasi untuk laporan berikut.</p>
        </div>

        <!-- ALERT -->
        <%- include('../partials/alert', { errorMsg: errorMsg, successMsg: successMsg }) %>

        <!-- Info laporan singkat -->
        <div class="mb-6 bg-orange-50 border border-orange-200 rounded-lg p-4 space-y-1">
          <p class="text-sm text-gray-700">
            <span class="font-medium">Judul Laporan   :</span> <%= laporan.judul_laporan || '-' %>
          </p>
          <p class="text-sm text-gray-700">
            <span class="font-medium">Program Kerja   :</span> <%= laporan.namaProker || '-' %>
          </p>
          <p class="text-sm text-gray-700">
            <span class="font-medium">Divisi HMSI     :</span> <%= laporan.divisi || '-' %>
          </p>
          <p class="text-sm text-gray-700">
            <span class="font-medium">Tanggal Upload  :</span> <%= laporan.tanggalFormatted || '-' %>
          </p>
        </div>

        <!-- Preview Dokumentasi -->
        <div class="mb-8">
          <h4 class="text-lg font-semibold text-orange-600 mb-4">Preview Dokumentasi</h4>
          <% if (laporan.dokumentasi) { %>
            <% if (laporan.dokumentasi_mime === 'application/pdf') { %>
              <embed src="/uploads/<%= laporan.dokumentasi %>" 
                     type="application/pdf" 
                     width="100%" 
                     height="420px"
                     class="rounded-lg border-2 border-orange-500"/>   
            <% } else if (laporan.dokumentasi_mime === 'image/jpeg' || laporan.dokumentasi_mime === 'image/png') { %>
              <img src="/uploads/<%= laporan.dokumentasi %>" alt="Dokumentasi" class="w-full max-h-96 object-contain rounded-lg border shadow"/>
              <a href="/uploads/<%= laporan.dokumentasi %>" class="mt-3 inline-block px-4 py-2 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium hover:bg-orange-200 transition">Download Gambar</a>
            <% } else { %>
              <div class="p-4 bg-gray-50 border rounded-lg flex items-center justify-between">
                <div>
                  <p class="font-medium"><%= laporan.dokumentasi %></p>
                  <p class="text-xs text-gray-500">Tipe file tidak dapat dipreview â€” silakan unduh.</p>
                </div>
                <a href="/uploads/<%= laporan.dokumentasi %>" class="px-3 py-2 bg-orange-100 text-orange-700 rounded-lg text-sm font-medium">Download</a>
              </div>
            <% } %>
          <% } else { %>
            <p class="text-gray-600 text-sm">Tidak ada dokumentasi diunggah.</p>
          <% } %>
        </div>

        <!-- Komentar HMSI -->
        <% if (laporan.komentar_hmsi) { %>
        <div class="mb-8">
          <h4 class="text-lg font-semibold text-teal-600 mb-4">Komentar HMSI</h4>
          <div class="p-4 bg-teal-50 border border-teal-200 rounded-lg space-y-2">
            <p class="text-gray-800 whitespace-pre-line"><%= laporan.komentar_hmsi %></p>
          </div>
        </div>
        <% } %>

        <!-- Form Evaluasi -->
        <form id="evaluationForm" action="/dpa/laporan/<%= laporan.id_laporan %>/evaluasi" method="POST" class="space-y-6">

          <!-- Komentar Evaluasi -->
          <div>
            <label for="komentar" class="block text-sm font-medium text-gray-700">Komentar Evaluasi</label>
            <textarea id="komentar" name="komentar" rows="5" required
                class="mt-2 block w-full rounded-xl border border-gray-300 shadow-sm 
                    focus:border-orange-500 focus:ring-2 focus:ring-orange-500 
                    focus:bg-orange-50 text-gray-900 placeholder-gray-400 focus:placeholder-orange-400
                    transition-all duration-300 ease-in-out p-3 outline-none"
                placeholder="Tulis komentar evaluasi di sini..."></textarea>
          </div>

          <!-- Status Evaluasi (Custom Dropdown) -->
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Status Evaluasi</label>
            <div class="relative w-60">
              <button id="dropdownButton" type="button"
                class="flex items-center justify-between w-full px-4 py-3 border border-gray-300 rounded-xl text-sm bg-white
                       hover:border-orange-500 hover:shadow-md focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all duration-200">
                <span id="dropdownLabel">Pilih Status</span>
                <i class="fa-solid fa-chevron-down text-orange-500"></i>
              </button>
              <div id="dropdownMenu"
                class="hidden absolute left-0 mt-2 w-full bg-white border border-orange-200 rounded-lg shadow-lg z-10">
                <ul class="text-sm text-gray-700">
                  <li><button type="button" class="w-full text-left px-4 py-2 hover:bg-orange-100" data-value="Revisi">Revisi</button></li>
                  <li><button type="button" class="w-full text-left px-4 py-2 hover:bg-orange-100" data-value="Selesai">Selesai</button></li>
                </ul>
              </div>
            </div>
            <input type="hidden" name="status_konfirmasi" id="statusInput" required>
          </div>

          <!-- Hidden Pemberi Evaluasi (auto dari req.session) -->
          <input type="hidden" name="id_anggota" value="<%= user.id_anggota %>">

          <!-- Tombol -->
          <div class="flex justify-end gap-3">
            <a href="/dpa/laporan/<%= laporan.id_laporan %>"
              class="px-6 py-3 bg-gray-200 text-gray-700 rounded-xl text-sm font-medium hover:bg-gray-300 transition">
              Batal
            </a>
            <button type="submit" id="submitBtn"
              class="flex items-center justify-center gap-2 px-6 py-3 bg-orange-500 text-white rounded-xl text-sm font-semibold hover:bg-orange-600 transition transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
              <span id="btnText">Simpan Evaluasi</span>
              <div id="btnSpinner" class="hidden w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Animasi -->
  <style>
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    @keyframes slideDown { from {opacity:0; transform:translateY(-20px);} to {opacity:1; transform:translateY(0);} }
    @keyframes slideUp { from {opacity:0; transform:translateY(20px);} to {opacity:1; transform:translateY(0);} }
    @keyframes slideInRight { from {opacity:0; transform:translateX(30px);} to {opacity:1; transform:translateX(0);} }

    .animate-fade-in { animation: fadeIn 0.7s ease-out forwards; }
    .animate-slide-down { animation: slideDown 0.8s ease-out forwards; }
    .animate-slide-up { animation: slideUp 0.6s ease-out forwards; }
    .animate-slide-in-right { animation: slideInRight 0.8s ease-out forwards; }

    /* Animasi pulse oren */
    @keyframes pulseOrange {
      0% { box-shadow: 0 0 0 0 rgba(249,115,22, 0.4); }
      70% { box-shadow: 0 0 0 6px rgba(249,115,22, 0); }
      100% { box-shadow: 0 0 0 0 rgba(249,115,22, 0); }
    }

    textarea:focus {
      animation: pulseOrange 1s infinite;
    }
  </style>

  <!-- Script -->
  <script>
    // Pop-up Message Utility Class
    class PopupMessage {
      // Modal Animation Functions
      static showModal(modalId) {
        const modal = document.getElementById(modalId);
        const content = document.getElementById(modalId + 'Content');
        
        if (!modal || !content) return;
        
        modal.classList.remove('hidden');
        
        // Trigger animation
        setTimeout(() => {
          content.classList.remove('scale-95', 'opacity-0');
          content.classList.add('scale-100', 'opacity-100');
        }, 10);
      }

      static hideModal(modalId, callback = null) {
        const modal = document.getElementById(modalId);
        const content = document.getElementById(modalId + 'Content');
        
        if (!modal || !content) return;
        
        content.classList.remove('scale-100', 'opacity-100');
        content.classList.add('scale-95', 'opacity-0');
        
        setTimeout(() => {
          modal.classList.add('hidden');
          if (callback) callback();
        }, 300);
      }

      // Success Message
      static showSuccess(title = 'Berhasil!', message = 'Operasi berhasil dilakukan.', buttonText = 'OK', callback = null) {
        document.getElementById('successModalTitle').textContent = title;
        document.getElementById('successModalMessage').textContent = message;
        
        const button = document.getElementById('closeSuccessModal');
        button.textContent = buttonText;
        
        // Remove existing event listeners
        button.replaceWith(button.cloneNode(true));
        const newButton = document.getElementById('closeSuccessModal');
        
        newButton.addEventListener('click', () => {
          this.hideModal('successModal', callback);
        });
        
        this.showModal('successModal');
      }

      // Error Message
      static showError(title = 'Gagal!', message = 'Terjadi kesalahan saat memproses data.', buttonText = 'Tutup', callback = null) {
        document.getElementById('errorModalTitle').textContent = title;
        document.getElementById('errorMessage').textContent = message;
        
        const button = document.getElementById('closeErrorModal');
        button.textContent = buttonText;
        
        // Remove existing event listeners
        button.replaceWith(button.cloneNode(true));
        const newButton = document.getElementById('closeErrorModal');
        
        newButton.addEventListener('click', () => {
          this.hideModal('errorModal', callback);
        });
        
        this.showModal('errorModal');
      }

      // Warning/Validation Message
      static showWarning(title = 'Peringatan!', message = 'Data tidak lengkap atau tidak valid.', buttonText = 'Mengerti', callback = null) {
        document.getElementById('validationModalTitle').textContent = title;
        document.getElementById('validationMessage').textContent = message;
        
        const button = document.getElementById('closeValidationModal');
        button.textContent = buttonText;
        
        // Remove existing event listeners
        button.replaceWith(button.cloneNode(true));
        const newButton = document.getElementById('closeValidationModal');
        
        newButton.addEventListener('click', () => {
          this.hideModal('validationModal', callback);
        });
        
        this.showModal('validationModal');
      }

      // Info Message
      static showInfo(title = 'Informasi', message = 'Informasi penting untuk Anda.', buttonText = 'Mengerti', callback = null) {
        document.getElementById('infoModalTitle').textContent = title;
        document.getElementById('infoModalMessage').textContent = message;
        
        const button = document.getElementById('closeInfoModal');
        button.textContent = buttonText;
        
        // Remove existing event listeners
        button.replaceWith(button.cloneNode(true));
        const newButton = document.getElementById('closeInfoModal');
        
        newButton.addEventListener('click', () => {
          this.hideModal('infoModal', callback);
        });
        
        this.showModal('infoModal');
      }

      // Confirmation Dialog
      static showConfirm(title = 'Konfirmasi', message = 'Apakah Anda yakin ingin melanjutkan?', onConfirm = null, onCancel = null, confirmText = 'Ya', cancelText = 'Batal') {
        document.getElementById('confirmModalTitle').textContent = title;
        document.getElementById('confirmModalMessage').textContent = message;
        
        const confirmButton = document.getElementById('proceedConfirmModal');
        const cancelButton = document.getElementById('cancelConfirmModal');
        
        confirmButton.textContent = confirmText;
        cancelButton.textContent = cancelText;
        
        // Remove existing event listeners
        confirmButton.replaceWith(confirmButton.cloneNode(true));
        cancelButton.replaceWith(cancelButton.cloneNode(true));
        
        const newConfirmButton = document.getElementById('proceedConfirmModal');
        const newCancelButton = document.getElementById('cancelConfirmModal');
        
        newConfirmButton.addEventListener('click', () => {
          this.hideModal('confirmModal', onConfirm);
        });
        
        newCancelButton.addEventListener('click', () => {
          this.hideModal('confirmModal', onCancel);
        });
        
        this.showModal('confirmModal');
      }

      // Loading Message
      static showLoading(title = 'Memproses...', message = 'Mohon tunggu sebentar.') {
        document.getElementById('loadingModalTitle').textContent = title;
        document.getElementById('loadingModalMessage').textContent = message;
        
        this.showModal('loadingModal');
      }

      // Hide Loading
      static hideLoading(callback = null) {
        this.hideModal('loadingModal', callback);
      }
    }

    // Original Modal functions (tetap menggunakan yang sudah ada)
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      const content = document.getElementById(modalId + 'Content');
      
      modal.classList.remove('hidden');
      
      // Trigger animation
      setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
      }, 10);
    }

    function hideModal(modalId) {
      const modal = document.getElementById(modalId);
      const content = document.getElementById(modalId + 'Content');
      
      content.classList.remove('scale-100', 'opacity-100');
      content.classList.add('scale-95', 'opacity-0');
      
      setTimeout(() => {
        modal.classList.add('hidden');
      }, 300);
    }

    // Modal event listeners
    document.getElementById('closeSuccessModal').addEventListener('click', () => {
      hideModal('successModal');
      setTimeout(() => {
        window.location.href = '/dpa/laporan';
      }, 300);
    });

    document.getElementById('closeErrorModal').addEventListener('click', () => {
      hideModal('errorModal');
    });

    document.getElementById('closeValidationModal').addEventListener('click', () => {
      hideModal('validationModal');
    });

    // Close modal when clicking outside
    ['successModal', 'errorModal', 'validationModal'].forEach(modalId => {
      document.getElementById(modalId).addEventListener('click', (e) => {
        if (e.target.id === modalId) {
          hideModal(modalId);
        }
      });
    });

    document.addEventListener("DOMContentLoaded", () => {
      // Dropdown functionality
      const dropdownButton = document.getElementById("dropdownButton");
      const dropdownMenu = document.getElementById("dropdownMenu");
      const dropdownLabel = document.getElementById("dropdownLabel");
      const statusInput = document.getElementById("statusInput");

      dropdownButton.addEventListener("click", () => {
        dropdownMenu.classList.toggle("hidden");
      });

      dropdownMenu.querySelectorAll("button").forEach(btn => {
        btn.addEventListener("click", () => {
          statusInput.value = btn.dataset.value;
          dropdownLabel.textContent = btn.dataset.value;
          dropdownMenu.classList.add("hidden");
        });
      });

      // Close dropdown when clicking outside
      window.addEventListener('click', (e) => {
        if (!dropdownButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
          dropdownMenu.classList.add('hidden');
        }
      });

      // Form submission with validation and popup menggunakan PopupMessage class
      const form = document.getElementById('evaluationForm');
      const submitBtn = document.getElementById('submitBtn');
      const btnText = document.getElementById('btnText');
      const btnSpinner = document.getElementById('btnSpinner');
      const komentarField = document.getElementById('komentar');

      form.addEventListener('submit', (e) => {
        e.preventDefault();
        
        // Validation
        const komentar = komentarField.value.trim();
        const status = statusInput.value;
        
        if (!komentar) {
          PopupMessage.showWarning('Data Tidak Lengkap!', 'Mohon isi komentar evaluasi sebelum menyimpan.');
          return;
        }
        
        if (!status) {
          PopupMessage.showWarning('Data Tidak Lengkap!', 'Mohon pilih status evaluasi sebelum menyimpan.');
          return;
        }
        
        // Show loading popup
        PopupMessage.showLoading('Menyimpan Evaluasi...', 'Mohon tunggu sebentar, evaluasi sedang diproses.');
        
        // Show loading state on button
        submitBtn.disabled = true;
        btnText.textContent = 'Menyimpan...';
        btnSpinner.classList.remove('hidden');
        
        // Prepare form data
        const formData = new FormData(form);
        
        // Convert FormData to URLSearchParams untuk compatibility dengan server
        const formParams = new URLSearchParams();
        formParams.append('komentar', komentarField.value.trim());
        formParams.append('status_konfirmasi', statusInput.value);
        formParams.append('id_anggota', form.querySelector('input[name="id_anggota"]').value);

        // Submit form menggunakan fetch dengan proper headers
        fetch(form.action, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: formParams
        })
        .then(response => {
          // Hide loading modal first
          PopupMessage.hideLoading(() => {
            if (response.ok || response.redirected) {
              // Show success popup
              PopupMessage.showSuccess(
                'Evaluasi Berhasil Disimpan!', 
                'Komentar evaluasi telah berhasil disimpan dan status laporan telah diperbarui.',
                'Kembali ke Daftar Laporan',
                () => {
                  window.location.href = '/dpa/kelolaLaporan';
                }
              );
            } else {
              return response.text().then(text => {
                throw new Error(text || 'Terjadi kesalahan saat menyimpan evaluasi');
              });
            }
          });
        })
        .catch(error => {
          console.error('Error:', error);
          // Hide loading modal first, then show error
          PopupMessage.hideLoading(() => {
            PopupMessage.showError(
              'Gagal Menyimpan Evaluasi!', 
              'Terjadi kesalahan: ' + error.message
            );
          });
        })
        .finally(() => {
          submitBtn.disabled = false;
          btnText.textContent = 'Simpan Evaluasi';
          btnSpinner.classList.add('hidden');
        });
      });

      // Initialize PopupMessage event listeners
      PopupMessage.init();
    });

    // Extended PopupMessage class with init method
    PopupMessage.init = function() {
      // Close modal when clicking outside
      const modals = ['successModal', 'errorModal', 'validationModal', 'infoModal', 'confirmModal'];
      
      modals.forEach(modalId => {
        const modal = document.getElementById(modalId);
        if (modal) {
          modal.addEventListener('click', (e) => {
            if (e.target.id === modalId) {
              this.hideModal(modalId);
            }
          });
        }
      });

      // ESC key to close modals
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          modals.forEach(modalId => {
            const modal = document.getElementById(modalId);
            if (modal && !modal.classList.contains('hidden')) {
              this.hideModal(modalId);
            }
          });
        }
      });
    };

    // Alias functions for easier usage
    function showSuccessMessage(title, message, buttonText, callback) {
      PopupMessage.showSuccess(title, message, buttonText, callback);
    }

    function showErrorMessage(title, message, buttonText, callback) {
      PopupMessage.showError(title, message, buttonText, callback);
    }

    function showWarningMessage(title, message, buttonText, callback) {
      PopupMessage.showWarning(title, message, buttonText, callback);
    }

    function showInfoMessage(title, message, buttonText, callback) {
      PopupMessage.showInfo(title, message, buttonText, callback);
    }

    function showConfirmDialog(title, message, onConfirm, onCancel, confirmText, cancelText) {
      PopupMessage.showConfirm(title, message, onConfirm, onCancel, confirmText, cancelText);
    }

    function showLoadingMessage(title, message) {
      PopupMessage.showLoading(title, message);
    }

    function hideLoadingMessage(callback) {
      PopupMessage.hideLoading(callback);
    }
  </script>

</body>
</html>